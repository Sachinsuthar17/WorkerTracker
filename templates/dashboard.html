{% extends "layout.html" %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> Production Dashboard</h1>
    <div class="live-indicator">
        <div class="pulse-dot"></div>
        <span>Live</span>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalWorkers">{{ total_workers }}</div>
            <div class="stat-label">Active Workers</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalBundles">{{ total_bundles }}</div>
            <div class="stat-label">Total Bundles</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="pendingBundles">{{ pending_bundles }}</div>
            <div class="stat-label">Pending Bundles</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="completedBundles">{{ completed_bundles }}</div>
            <div class="stat-label">Completed Bundles</div>
        </div>
    </div>
</div>

<!-- Dashboard Content -->
<div class="dashboard-grid">
    <!-- Recent Activities -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3><i class="fas fa-history"></i> Recent Activities</h3>
        </div>
        <div class="card-body">
            <div class="activities-list" id="recentActivities">
                {% for log, worker_name in recent_logs %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-{{ 'sign-in-alt' if log.action_type == 'login' else 'sign-out-alt' if log.action_type == 'logout' else 'qrcode' }}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">{{ worker_name }}</div>
                        <div class="activity-desc">{{ log.action_type.title() }}</div>
                        <div class="activity-time">{{ log.timestamp.strftime('%H:%M') }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Bundle Status Overview -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3><i class="fas fa-chart-pie"></i> Bundle Status</h3>
        </div>
        <div class="card-body">
            <div class="progress-overview">
                <div class="progress-item">
                    <div class="progress-label">Pending</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-pending" style="width: {{ (pending_bundles / total_bundles * 100) if total_bundles > 0 else 0 }}%"></div>
                    </div>
                    <div class="progress-value">{{ pending_bundles }}</div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">In Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-active" style="width: {{ ((total_bundles - pending_bundles - completed_bundles) / total_bundles * 100) if total_bundles > 0 else 0 }}%"></div>
                    </div>
                    <div class="progress-value">{{ total_bundles - pending_bundles - completed_bundles }}</div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">Completed</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-completed" style="width: {{ (completed_bundles / total_bundles * 100) if total_bundles > 0 else 0 }}%"></div>
                    </div>
                    <div class="progress-value">{{ completed_bundles }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Stats -->
<div class="additional-stats">
    <div class="stat-row">
        <div class="stat-item">
            <i class="fas fa-cut"></i>
            <span class="stat-name">Total Pieces</span>
            <span class="stat-number" id="totalPieces">-</span>
        </div>
        <div class="stat-item">
            <i class="fas fa-rupee-sign"></i>
            <span class="stat-name">Total Earnings</span>
            <span class="stat-number" id="totalEarnings">-</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh dashboard data
function refreshDashboardStats() {
    fetch('/api/dashboard_stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalWorkers').textContent = data.total_workers;
            document.getElementById('totalBundles').textContent = data.total_bundles;
            document.getElementById('pendingBundles').textContent = data.pending_bundles;
            document.getElementById('completedBundles').textContent = data.completed_bundles;
            document.getElementById('totalPieces').textContent = data.total_pieces;
            document.getElementById('totalEarnings').textContent = 'â‚¹' + data.total_earnings;
        })
        .catch(error => console.error('Error fetching dashboard stats:', error));
}

// Refresh every 30 seconds
setInterval(refreshDashboardStats, 30000);

// Initial load
refreshDashboardStats();
</script>
{% endblock %}