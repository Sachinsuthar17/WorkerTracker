{% extends "layout.html" %}

{% block content %}
  <h1>Production Dashboard</h1>
  <div class="cards">
    <div class="card">
      <div class="card-title">Active Orders</div>
      <div class="card-value">{{ total_bundles }}</div>
    </div>
    <div class="card">
      <div class="card-title">Active Bundles</div>
      <div class="card-value">{{ total_bundles }}</div>
    </div>
    <div class="card">
      <div class="card-title">Active Workers</div>
      <div class="card-value">{{ total_workers }}</div>
    </div>
    <div class="card">
      <div class="card-title">Today's Scans</div>
      <div class="card-value" id="today-scans">{{ active_scans }}</div>
    </div>
    <div class="card">
      <div class="card-title">Today's Earnings</div>
      <div class="card-value">${{ '%.2f' % earnings_today }}</div>
    </div>
  </div>

  <h2>Recent Activities</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Worker</th>
        <th>Operation</th>
      </tr>
    </thead>
    <tbody>
      {% for ts, worker_name, op_seq in recent %}
      <tr>
        <td>{{ ts }}</td>
        <td>{{ worker_name }}</td>
        <td>{{ op_seq }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    // Live update today's scans via Server-Sent Events.  The browser will
    // automatically reconnect if the connection drops.  The count is
    // replaced when a new message is received.
    (function () {
      var el = document.getElementById('today-scans');
      try {
        var src = new EventSource('/events');
        src.onmessage = function (ev) {
          var data = JSON.parse(ev.data);
          el.textContent = data.today_scans;
        };
      } catch (e) {
        console.warn('SSE not available:', e);
      }
    })();
  </script>
{% endblock %}