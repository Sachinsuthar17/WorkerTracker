{% extends 'layout.html' %}
{% set spa = true %}
{% block title %}Production Management System{% endblock %}

{% block content %}
  <!-- Ensure checkboxes are visible regardless of global resets -->
  <style>
    .checkbox-cell { width: 52px; text-align: center; }
    .checkbox-cell input[type="checkbox"]{
      width: 18px; height: 18px; cursor: pointer; vertical-align: middle;
      appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;
      accent-color: #3b82f6;
    }
    .bulk-actions {
      display:flex; align-items:center; justify-content:space-between;
      margin:.5rem 0 1rem; gap:.75rem;
    }
    .bulk-actions .checkbox-all { display:flex; align-items:center; gap:.5rem; }
    .btn--danger { background:#ef4444; color:#fff; }
    .btn--danger:hover { filter:brightness(1.05); }
    .qr-thumb { display:block; }
    #sel-count { color: var(--text-muted); font-size: .85rem; margin-left: .5rem; }
  </style>

  <!-- Dashboard Section -->
  <section class="section active" id="dashboard">
    <div class="section-header">
      <h1>Dashboard</h1>
      <div class="header-actions">
        <button id="refreshBtn" class="btn btn--secondary" type="button">Refresh</button>
        <span id="lastUpdated" class="last-updated"></span>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon">üë•</div>
        <div class="kpi-content">
          <div id="activeWorkers" class="kpi-value">0</div>
          <div class="kpi-label">Active Workers</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üì¶</div>
        <div class="kpi-content">
          <div id="totalBundles" class="kpi-value">0</div>
          <div class="kpi-label">Total Bundles</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">‚öôÔ∏è</div>
        <div class="kpi-content">
          <div id="totalOperations" class="kpi-value">0</div>
          <div class="kpi-label">Operations</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">‚Çπ</div>
        <div class="kpi-content">
          <div id="totalEarnings" class="kpi-value">0.00</div>
          <div class="kpi-label">Earnings (demo)</div>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>Bundle Status</h3>
        <div class="chart-container"><canvas id="bundleStatusChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Department Workload</h3>
        <div class="chart-container"><canvas id="departmentChart"></canvas></div>
      </div>
    </div>

    <div class="activity-card">
      <h3>Recent Activity</h3>
      <div id="activityFeed" class="activity-feed"></div>
    </div>
  </section>

  <!-- Worker Management Section -->
  <section class="section" id="workers">
    <div class="section-header">
      <h1>Worker Management</h1>
      <div class="header-controls">
        <input type="text" class="form-control search-input" id="workerSearch" placeholder="Search workers...">
        <select class="form-control" id="departmentFilter">
          <option value="">All Departments</option>
          <option value="Cutting">Cutting</option>
          <option value="Sewing">Sewing</option>
          <option value="Finishing">Finishing</option>
          <option value="Quality">Quality</option>
          <option value="Packing">Packing</option>
        </select>
        <select class="form-control" id="statusFilter">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Idle">Idle</option>
        </select>

        <a href="{{ url_for('add_worker') }}" class="btn btn--primary btn-sm">+ Add Worker</a>
        <form action="{{ url_for('upload_workers') }}" method="post" enctype="multipart/form-data" style="display:inline;">
          <input type="file" name="file" accept=".xlsx" required class="form-control btn-sm" style="display:inline-block;">
          <button type="submit" class="btn btn--outline btn-sm">Bulk Upload Excel</button>
        </form>
      </div>
    </div>

    <!-- Bulk actions toolbar -->
    <div class="bulk-actions">
      <label class="checkbox-all">
        <input type="checkbox" id="select-all-workers">
        <span>Select all</span>
      </label>
      <div class="bulk-buttons">
        <button id="btn-delete-selected" class="btn btn--danger btn-sm" type="button">Delete selected</button>
        <button id="btn-print-selected" class="btn btn--secondary btn-sm" type="button">Print selected</button>
        <span id="sel-count"></span>
      </div>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="checkbox-cell">
              <input type="checkbox" id="select-all-header">
            </th>
            <th>Name</th>
            <th>Token ID</th>
            <th>Department</th>
            <th>Line</th>
            <th>Status</th>
            <th>QR Code</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="workersTable">
          {% for worker in workers %}
            <tr>
              <td class="checkbox-cell">
                <input type="checkbox" class="worker-select" value="{{ worker.id }}" data-id="{{ worker.id }}">
              </td>
              <td>{{ worker.name }}</td>
              <td><code>{{ worker.token_id }}</code></td>
              <td><span class="department-tag">{{ worker.department }}</span></td>
              <td>{{ worker.line or 'N/A' }}</td>
              <td>
                {% if worker.active %}
                  <span class="status-badge status-active">ACTIVE</span>
                {% else %}
                  <span class="status-badge status-idle">INACTIVE</span>
                {% endif %}
              </td>
              <td>
                {% if worker.qrcode_path %}
                  <img class="qr-thumb" src="{{ url_for('static', filename=worker.qrcode_path) }}" width="40" height="40" alt="QR">
                {% else %}No QR{% endif %}
              </td>
              <td class="actions-cell">
                <a href="{{ url_for('print_qr', worker_id=worker.id) }}" target="_blank" class="btn btn--secondary btn-sm">Print</a>
                <a href="{{ url_for('download_qr', worker_id=worker.id) }}" class="btn btn--outline btn-sm">Download</a>
                <a href="{{ url_for('edit_worker', worker_id=worker.id) }}" class="btn btn--primary btn-sm">Edit</a>
                <a href="{{ url_for('delete_worker', worker_id=worker.id) }}" class="btn btn--secondary btn-sm"
                   onclick="return confirm('Are you sure you want to delete this worker?');">Delete</a>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="8" class="loading">No workers found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Operations -->
  <section class="section" id="operations">
    <div class="section-header">
      <h1>Operations Management</h1>
      <input id="operationSearch" class="form-control search-input" placeholder="Search operations...">
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr><th>Seq</th><th>Op No</th><th>Description</th><th>Machine</th><th>Department</th><th>Std Min</th><th>Piece Rate</th></tr>
        </thead>
        <tbody id="operationsTable"></tbody>
      </table>
    </div>
  </section>

  <!-- Bundles -->
  <section class="section" id="bundles">
    <div class="section-header"><h1>Bundle Management</h1></div>
    <div class="bundles-grid" id="bundlesGrid"></div>
  </section>

  <!-- Production Order -->
  <section class="section" id="production-order">
    <div class="section-header"><h1>Production Order</h1></div>
    <div class="order-details">
      <div class="order-card">
        <h3>Latest Order</h3>
        <div class="order-info">
          <div class="info-row"><span class="label">Order No</span><span class="value" id="orderNo">-</span></div>
          <div class="info-row"><span class="label">Style</span><span class="value" id="orderStyle">-</span></div>
          <div class="info-row"><span class="label">Quantity</span><span class="value" id="orderQuantity">-</span></div>
          <div class="info-row"><span class="label">Buyer</span><span class="value" id="orderBuyer">-</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Scanner (UI demo) -->
  <section class="section" id="scanner">
    <div class="section-header"><h1>ESP32 Scanner</h1></div>
    <div class="scanner-container">
      <div class="scanner-display">
        <div class="scanner-screen">
          <div class="scan-line"></div>
          <div id="scannerStatus" class="scanner-status">Ready to Scan</div>
          <div id="scanResult" class="scan-result"></div>
        </div>
        <div class="scanner-controls">
          <button id="startScan" class="btn btn--primary" type="button">Start</button>
          <button id="stopScan" class="btn btn--secondary" type="button" disabled>Stop</button>
          <button id="resetScan" class="btn btn--outline" type="button">Reset</button>
        </div>
      </div>
      <div class="recent-scans">
        <h4>Recent Scans</h4>
        <div id="recentScans" class="scans-list">
          <div class="scan-item">No recent scans</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Reports placeholder -->
  <section class="section" id="reports">
    <div class="section-header"><h1>Reports</h1></div>
    <div class="reports-grid">
      <div class="report-card">
        <h3>Production Summary</h3>
        <p>Summary report (coming soon)</p>
        <button class="btn btn--secondary" type="button" onclick="alert('Coming soon')">Generate</button>
      </div>
    </div>
  </section>

  <!-- Page-specific JS -->
  <script>
    // ===== Helpers =====
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const tbody      = $('#workersTable');
    const headerAll  = $('#select-all-header');
    const toolbarAll = $('#select-all-workers');
    const selCount   = $('#sel-count');

    // Always query fresh (works after re-renders)
    const getRowChecks = () => Array.from(document.querySelectorAll('#workersTable input.worker-select'));
    const selectedIds  = () => getRowChecks().filter(cb => cb.checked).map(cb => parseInt(cb.dataset.id));

    function updateSelCount(){
      const n = selectedIds().length;
      if (selCount) selCount.textContent = n ? `${n} selected` : '';
    }

    function setAllRows(checked){
      const checks = getRowChecks();
      for (const cb of checks){ cb.checked = checked; }
      updateSelCount();
    }

    function syncMasterChecks(){
      const checks = getRowChecks();
      const allChecked = checks.length > 0 && checks.every(cb => cb.checked);
      if (headerAll)  headerAll.checked = allChecked;
      if (toolbarAll) toolbarAll.checked = allChecked;
      updateSelCount();
    }

    // ===== Render workers rows (our renderer for /api/workers) =====
    function renderWorkers(workers){
      if (!tbody) return;

      if (!workers || workers.length === 0){
        tbody.innerHTML = '<tr><td colspan="8" class="loading">No workers found</td></tr>';
        if (headerAll)  headerAll.checked = false;
        if (toolbarAll) toolbarAll.checked = false;
        updateSelCount();
        return;
      }

      const esc = (s)=> (s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));

      const rows = workers.map(w=>{
        const statusHtml = w.active
          ? '<span class="status-badge status-active">ACTIVE</span>'
          : '<span class="status-badge status-idle">INACTIVE</span>';

        const qrSrc = w.qrcode_path ? ('/static/' + String(w.qrcode_path).replace(/^\/+/, '')) : '';
        const qrHtml = w.qrcode_path
          ? `<img class="qr-thumb" src="${qrSrc}" width="40" height="40" alt="QR">`
          : 'No QR';

        return `
          <tr>
            <td class="checkbox-cell"><input type="checkbox" class="worker-select" value="${w.id}" data-id="${w.id}"></td>
            <td>${esc(w.name)}</td>
            <td><code>${esc(w.token_id)}</code></td>
            <td><span class="department-tag">${esc(w.department || '')}</span></td>
            <td>${esc(w.line || 'N/A')}</td>
            <td>${statusHtml}</td>
            <td>${qrHtml}</td>
            <td class="actions-cell">
              <a href="/print_qr/${w.id}" target="_blank" class="btn btn--secondary btn-sm">Print</a>
              <a href="/download_qr/${w.id}" class="btn btn--outline btn-sm">Download</a>
              <a href="/edit/${w.id}" class="btn btn--primary btn-sm">Edit</a>
              <a href="/delete/${w.id}" class="btn btn--secondary btn-sm" onclick="return confirm('Are you sure you want to delete this worker?');">Delete</a>
            </td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
      if (headerAll)  headerAll.checked = false;
      if (toolbarAll) toolbarAll.checked = false;
      updateSelCount();
    }

    // ===== Defensive patcher: if any other script rewrites the table without checkboxes, fix it =====
    function extractIdFromRow(tr){
      // Try common action links: edit / print_qr / download_qr / delete
      const link = tr.querySelector('a[href*="/edit/"], a[href*="/print_qr/"], a[href*="/download_qr/"], a[href*="/delete/"]');
      if (link){
        const m = link.getAttribute('href').match(/\/(?:edit|print_qr|download_qr|delete)\/(\d+)/);
        if (m) return parseInt(m[1], 10);
      }
      return null;
    }

    function ensureCheckboxesPresent(){
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach(tr => {
        // If this row already has a worker checkbox, skip
        if (tr.querySelector('input.worker-select')) return;

        // Try to prepend a checkbox cell if we can find the id
        const id = extractIdFromRow(tr);
        if (!isNaN(id) && id != null){
          const td = document.createElement('td');
          td.className = 'checkbox-cell';
          td.innerHTML = `<input type="checkbox" class="worker-select" value="${id}" data-id="${id}">`;
          // Prepend as first cell
          if (tr.firstElementChild){
            tr.insertBefore(td, tr.firstElementChild);
          } else {
            tr.appendChild(td);
          }
        }
      });
      syncMasterChecks();
    }

    // Watch for any DOM changes in the workers table body
    const mo = new MutationObserver(() => ensureCheckboxesPresent());
    if (tbody){
      mo.observe(tbody, { childList: true, subtree: true });
      // Also run once on load to fix whatever is currently there
      ensureCheckboxesPresent();
    }

    // ===== Fetch filtered workers using our renderer =====
    async function loadWorkers(){
      const search = ($('#workerSearch')?.value || '').trim();
      const department = $('#departmentFilter')?.value || '';
      const status = $('#statusFilter')?.value || '';
      const q = new URLSearchParams();
      if (search)     q.set('search', search);
      if (department) q.set('department', department);
      if (status)     q.set('status', status);

      try {
        const res = await fetch('/api/workers' + (q.toString() ? ('?' + q.toString()) : ''));
        if (!res.ok) throw new Error('Failed to load workers');
        const data = await res.json();
        renderWorkers(data);
      } catch (err){
        console.error(err);
      }
    }

    // ===== Debounce =====
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    // ===== Bulk actions =====
    async function deleteSelected(){
      const ids = selectedIds();
      if (ids.length === 0){ alert('No workers selected.'); return; }
      if (!confirm(`Delete ${ids.length} worker(s)? This cannot be undone.`)) return;

      try {
        const res = await fetch('/api/workers/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (!res.ok){
          const msg = await res.json().catch(()=>({}));
          throw new Error(msg.error || 'Delete failed');
        }
        await loadWorkers();
      } catch(e){
        alert(e.message || 'Delete failed.');
      }
    }

    function printSelected(){
      const ids = selectedIds();
      if (ids.length === 0){ alert('No workers selected.'); return; }
      window.open('/print_qrs?ids=' + ids.join(','), '_blank');
    }

    // ===== Wire up =====
    window.addEventListener('DOMContentLoaded', () => {
      // Master checkboxes
      headerAll?.addEventListener('change', e => {
        setAllRows(e.target.checked);
        if (toolbarAll) toolbarAll.checked = e.target.checked;
        syncMasterChecks();
      });
      toolbarAll?.addEventListener('change', e => {
        setAllRows(e.target.checked);
        if (headerAll) headerAll.checked = e.target.checked;
        syncMasterChecks();
      });

      // Row checkbox changes (delegated)
      tbody?.addEventListener('change', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLInputElement)) return;
        if (!t.classList.contains('worker-select')) return;
        syncMasterChecks();
      });

      // Bulk buttons
      $('#btn-delete-selected')?.addEventListener('click', deleteSelected);
      $('#btn-print-selected')?.addEventListener('click', printSelected);

      // Filters
      $('#workerSearch')?.addEventListener('input', debounce(loadWorkers, 250));
      $('#departmentFilter')?.addEventListener('change', loadWorkers);
      $('#statusFilter')?.addEventListener('change', loadWorkers);

      // Optional: run an initial fetch so our renderer owns the table contents
      // (If another script repaints later, the MutationObserver will restore checkboxes)
      // loadWorkers();
    });
  </script>
{% endblock %}
