{% extends "layout.html" %}
{% set title = "Workers" %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="left">
      <h2 class="card-title">Workers</h2>
      <p class="card-sub">Manage users, tokens & QR codes</p>
    </div>
    <form method="get" class="search">
      <input type="text" name="q" placeholder="Search name / token / dept" value="{{search or ''}}">
      <button type="submit" class="btn">Search</button>
      <a href="{{ url_for('workers_page') }}" class="btn btn-ghost">Clear</a>
    </form>
  </div>

  <div class="card-body">
    <details class="create-box" open>
      <summary><strong>Add New Worker</strong></summary>
      <form method="post" action="{{ url_for('worker_create') }}" class="grid">
        <label>
          <span>Name</span>
          <input required name="name" placeholder="e.g. Rahul Sharma">
        </label>
        <label>
          <span>Token (manual)</span>
          <input required name="token_id" placeholder="e.g. RAHUL123 (no W:)">
        </label>
        <label>
          <span>Department / Line</span>
          <input name="department" placeholder="e.g. Stitching A1">
        </label>
        <div class="row-actions">
          <button class="btn">Create</button>
        </div>
      </form>
      <p class="hint">QR content will be generated as <code>W:&lt;TOKEN&gt;</code>. The ESP32 uses that for login / logout toggle & auto-switch.</p>
    </details>

    {% if workers %}
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Token</th>
            <th>Dept</th>
            <th>QR</th>
            <th style="width:240px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for w in workers %}
          <tr>
            <td>
              <form method="post" action="{{ url_for('worker_edit', wid=w.id) }}" class="inline-form">
                <input name="name" value="{{ w.name }}" required>
            </td>
            <td>
                <input name="token_id" value="{{ w.token_id }}" required>
            </td>
            <td>
                <input name="department" value="{{ w.department or '' }}">
            </td>
            <td>
              <img src="{{ url_for('worker_qr_png', wid=w.id) }}" alt="QR" class="qr-thumb">
            </td>
            <td class="actions">
                <button class="btn btn-small">Save</button>
              </form>
              <a class="btn btn-small btn-ghost" href="{{ url_for('worker_print', wid=w.id) }}" target="_blank">Print QR</a>
              <form method="post" action="{{ url_for('worker_delete', wid=w.id) }}" class="inline-form" onsubmit="return confirm('Delete this worker?');">
                <button class="btn btn-small btn-danger">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="empty">No workers yet. Add your first worker above.</div>
    {% endif %}
  </div>
</div>

{% if get_flashed_messages(with_categories=true) %}
  <div class="flash-wrap">
    {% for cat,msg in get_flashed_messages(with_categories=true) %}
      <div class="flash {{cat}}">{{ msg }}</div>
    {% endfor %}
  </div>
{% endif %}

<style>
.card { background:#0b1220; border:1px solid #1b2742; border-radius:14px; }
.card-header { display:flex; align-items:end; justify-content:space-between; padding:18px 18px 0; }
.card-title { margin:0; font-size:20px; color:#e8f0ff; }
.card-sub { margin:2px 0 0; color:#9bb0cc; font-size:12px; }
.card-body { padding:16px; }
.search { display:flex; gap:8px; }
.search input { min-width:260px; }
.create-box { background:#0e1730; border:1px dashed #2a3a68; border-radius:10px; padding:12px 14px; margin-bottom:16px; }
.create-box summary { cursor:pointer; color:#cfe0ff; margin-bottom:8px; }
.grid { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:12px; align-items:end; }
.grid label span { display:block; font-size:12px; color:#9db3d9; margin-bottom:6px; }
.row-actions { display:flex; gap:8px; }
.table-wrap { overflow:auto; border-radius:12px; border:1px solid #1b2742; }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { padding:10px 12px; border-bottom:1px solid #15213a; color:#dfe8ff; }
.table th { text-align:left; color:#9bb0cc; font-weight:600; background:#0f1a33; position:sticky; top:0; }
.inline-form { display:inline; }
.qr-thumb { height:56px; width:56px; object-fit:contain; background:#fff; border-radius:8px; }
.actions { display:flex; gap:8px; align-items:center; }
input, select { background:#091126; color:#e8f0ff; border:1px solid #1b2742; border-radius:8px; padding:8px 10px; width:100%; }
.btn { background:#2d6be7; color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
.btn:hover { filter:brightness(1.08); }
.btn-ghost { background:transparent; border:1px solid #2d6be7; color:#cfe0ff; }
.btn-small { padding:6px 10px; border-radius:8px; font-size:12px; }
.btn-danger { background:#e02d3c; }
.empty { padding:18px; text-align:center; color:#9bb0cc; }
.flash-wrap { position:fixed; bottom:16px; right:16px; display:flex; flex-direction:column; gap:8px; }
.flash { padding:10px 12px; border-radius:10px; font-weight:600; }
.flash.success { background:#11391c; color:#b9ffd0; border:1px solid #236e38; }
.flash.error { background:#3a1218; color:#ffc4c9; border:1px solid #7a1e2a; }
@media (max-width: 900px){
  .grid{ grid-template-columns:1fr; }
  .search input { min-width:160px; }
}
</style>
{% endblock %}
